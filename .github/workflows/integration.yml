name: Integration - Contract Tests (FE ↔ BFF)

on:
  pull_request:
    paths:
      - "apps/backend/**"
      - "apps/frontend/**"
      - "packages/ai-core/**"
      - ".github/workflows/integration.yml"
  push:
    branches: ["main"]
    paths:
      - "apps/backend/**"
      - "apps/frontend/**"
      - "packages/ai-core/**"
      - ".github/workflows/integration.yml"

concurrency:
  group: integration-${{ github.ref }}
  cancel-in-progress: true

jobs:
  export-openapi:
    name: Export OpenAPI from FastAPI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/backend
    env:
      DATABASE_URL: "sqlite+pysqlite:///:memory:"
      AI_MODELS_DIR: "packages/ai-core/models"
      ALLOWED_ORIGINS: "http://localhost:3000"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show workspace & pwd
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          pwd
          ls -la

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install backend deps
        run: |
          pip install -r requirements.txt
          # Optional: chỉ cài ai-core nếu là package hợp lệ
          AI_CORE_PATH="../packages/ai-core"
          if [ -d "$AI_CORE_PATH" ] && { [ -f "$AI_CORE_PATH/pyproject.toml" ] || [ -f "$AI_CORE_PATH/setup.py" ]; }; then
            echo "Installing ai-core from $AI_CORE_PATH ..."
            pip install -e "$AI_CORE_PATH"
          else
            echo "Skip ai-core install."
          fi

      - name: Sanity import (fail fast)
        run: |
          python - <<'PY'
          import importlib, sys
          try:
              importlib.import_module("app.main")
              print("✅ import app.main OK")
          except Exception as e:
              print("❌ import app.main FAILED:", e)
              sys.exit(1)
          PY

      - name: Export openapi.json
        shell: bash
        run: |
          python - <<'PY'
          import json, os
          from fastapi.openapi.utils import get_openapi
          from app.main import app
          schema = app.openapi() if hasattr(app, "openapi") else get_openapi(
              title=getattr(app, "title", "API"),
              version=getattr(app, "version", "0.1.0"),
              routes=getattr(app, "routes", []),
          )
          out = "openapi.json"
          with open(out, "w", encoding="utf-8") as f:
              json.dump(schema, f, ensure_ascii=False, indent=2)
          print("✅ Wrote", os.path.abspath(out))
          PY

      - name: Verify openapi.json exists
        run: |
          pwd
          ls -l openapi.json
          test -f openapi.json

      - name: Upload OpenAPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          # dùng đường dẫn tuyệt đối để tránh nhầm thư mục
          path: ${{ github.workspace }}/apps/backend/openapi.json
          if-no-files-found: error
          retention-days: 7

  fe-contract:
    name: FE contract check against OpenAPI
    runs-on: ubuntu-latest
    needs: export-openapi
    defaults:
      run:
        working-directory: apps/frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download OpenAPI artifact
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec
          path: apps/backend

      - name: Verify artifact downloaded
        run: |
          ls -la ../backend
          test -f ../backend/openapi.json

      # Detect npm/yarn
      - name: Detect package manager
        id: detect
        run: |
          if [ -f "yarn.lock" ]; then
            echo "pkg=yarn" >> $GITHUB_OUTPUT
          else
            echo "pkg=npm" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node (npm)
        if: steps.detect.outputs.pkg == 'npm'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "apps/frontend/package-lock.json"

      - name: Setup Node (yarn)
        if: steps.detect.outputs.pkg == 'yarn'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"
          cache-dependency-path: "apps/frontend/yarn.lock"

      - name: Install FE deps (npm)
        if: steps.detect.outputs.pkg == 'npm'
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm i
          fi

      - name: Install FE deps (yarn)
        if: steps.detect.outputs.pkg == 'yarn'
        run: |
          if [ -f yarn.lock ]; then
            yarn install --frozen-lockfile || yarn install
          else
            yarn install
          fi

      - name: Generate TS types from OpenAPI
        run: npx --yes openapi-typescript ../backend/openapi.json -o src/types/backend.d.ts

      - name: Type check FE
        run: npx --yes tsc --noEmit
