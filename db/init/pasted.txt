-- Table: core.assessment_reports

-- DROP TABLE IF EXISTS core.assessment_reports;

CREATE TABLE IF NOT EXISTS core.assessment_reports
(
    id bigint NOT NULL DEFAULT nextval('core.assessment_reports_id_seq'::regclass),
    user_id bigint NOT NULL,
    session_id bigint,
    assessment_id bigint NOT NULL,
    template_id bigint NOT NULL,
    report_type text COLLATE pg_catalog."default" NOT NULL,
    locale text COLLATE pg_catalog."default" NOT NULL DEFAULT 'vi'::text,
    status text COLLATE pg_catalog."default" NOT NULL DEFAULT 'ready'::text,
    source_hash text COLLATE pg_catalog."default",
    computed_at timestamp with time zone NOT NULL DEFAULT now(),
    cover_json jsonb NOT NULL DEFAULT '{}'::jsonb,
    narrative_json jsonb NOT NULL DEFAULT '{}'::jsonb,
    scores_json jsonb NOT NULL DEFAULT '[]'::jsonb,
    facets_json jsonb NOT NULL DEFAULT '[]'::jsonb,
    strengths_json jsonb NOT NULL DEFAULT '[]'::jsonb,
    challenges_json jsonb NOT NULL DEFAULT '[]'::jsonb,
    pages_json jsonb NOT NULL DEFAULT '[]'::jsonb,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone NOT NULL DEFAULT now(),
    layout_version text COLLATE pg_catalog."default" DEFAULT 'print_v1'::text,
    CONSTRAINT assessment_reports_pkey PRIMARY KEY (id),
    CONSTRAINT fk_assessment_reports_assessment FOREIGN KEY (assessment_id)
        REFERENCES core.assessments (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE,
    CONSTRAINT fk_assessment_reports_session FOREIGN KEY (session_id)
        REFERENCES core.assessment_sessions (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE SET NULL,
    CONSTRAINT fk_assessment_reports_template FOREIGN KEY (template_id)
        REFERENCES core.report_templates (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE RESTRICT,
    CONSTRAINT fk_assessment_reports_user FOREIGN KEY (user_id)
        REFERENCES core.users (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS core.assessment_reports
    OWNER to postgres;

COMMENT ON COLUMN core.assessment_reports.layout_version
    IS 'Layout version used to generate this report (e.g., print_v1)';
-- Index: idx_assessment_reports_session

-- DROP INDEX IF EXISTS core.idx_assessment_reports_session;

CREATE INDEX IF NOT EXISTS idx_assessment_reports_session
    ON core.assessment_reports USING btree
    (session_id ASC NULLS LAST, created_at DESC NULLS FIRST)
    TABLESPACE pg_default;
-- Index: idx_assessment_reports_template

-- DROP INDEX IF EXISTS core.idx_assessment_reports_template;

CREATE INDEX IF NOT EXISTS idx_assessment_reports_template
    ON core.assessment_reports USING btree
    (template_id ASC NULLS LAST)
    TABLESPACE pg_default;
-- Index: idx_assessment_reports_user

-- DROP INDEX IF EXISTS core.idx_assessment_reports_user;

CREATE INDEX IF NOT EXISTS idx_assessment_reports_user
    ON core.assessment_reports USING btree
    (user_id ASC NULLS LAST, created_at DESC NULLS FIRST)
    TABLESPACE pg_default;
-- Index: idx_assessment_reports_user_assessment

-- DROP INDEX IF EXISTS core.idx_assessment_reports_user_assessment;

CREATE INDEX IF NOT EXISTS idx_assessment_reports_user_assessment
    ON core.assessment_reports USING btree
    (user_id ASC NULLS LAST, assessment_id ASC NULLS LAST, report_type COLLATE pg_catalog."default" ASC NULLS LAST, locale COLLATE pg_catalog."default" ASC NULLS LAST)
    TABLESPACE pg_default;
-- Index: ux_assessment_reports_unique

-- DROP INDEX IF EXISTS core.ux_assessment_reports_unique;

CREATE UNIQUE INDEX IF NOT EXISTS ux_assessment_reports_unique
    ON core.assessment_reports USING btree
    (assessment_id ASC NULLS LAST, report_type COLLATE pg_catalog."default" ASC NULLS LAST, locale COLLATE pg_catalog."default" ASC NULLS LAST)
    TABLESPACE pg_default;


    -- Table: core.assessments

-- DROP TABLE IF EXISTS core.assessments;

CREATE TABLE IF NOT EXISTS core.assessments
(
    id bigint NOT NULL DEFAULT nextval('core.assessments_id_seq'::regclass),
    user_id bigint NOT NULL,
    a_type text COLLATE pg_catalog."default" NOT NULL,
    scores jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    session_id bigint,
    processed_riasec_scores jsonb,
    processed_big_five_scores jsonb,
    top_interest text COLLATE pg_catalog."default",
    career_recommendations jsonb,
    essay_analysis jsonb,
    CONSTRAINT assessments_pkey PRIMARY KEY (id),
    CONSTRAINT assessments_user_id_fkey FOREIGN KEY (user_id)
        REFERENCES core.users (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE,
    CONSTRAINT fk_assess_session FOREIGN KEY (session_id)
        REFERENCES core.assessment_sessions (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE SET NULL
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS core.assessments
    OWNER to postgres;

COMMENT ON COLUMN core.assessments.processed_riasec_scores
    IS 'AI-processed RIASEC scores (0-1 scale) for persistence';

COMMENT ON COLUMN core.assessments.processed_big_five_scores
    IS 'AI-processed Big Five scores (0-1 scale) for persistence';

COMMENT ON COLUMN core.assessments.top_interest
    IS 'Top RIASEC interest letter (R/I/A/S/E/C)';

COMMENT ON COLUMN core.assessments.career_recommendations
    IS 'Array of recommended career IDs';

COMMENT ON COLUMN core.assessments.essay_analysis
    IS 'AI analysis of user essay responses';
-- Index: idx_assess_user_type

-- DROP INDEX IF EXISTS core.idx_assess_user_type;

CREATE INDEX IF NOT EXISTS idx_assess_user_type
    ON core.assessments USING btree
    (user_id ASC NULLS LAST, a_type COLLATE pg_catalog."default" ASC NULLS LAST)
    TABLESPACE pg_default;
-- Index: idx_assessments_type

-- DROP INDEX IF EXISTS core.idx_assessments_type;

CREATE INDEX IF NOT EXISTS idx_assessments_type
    ON core.assessments USING btree
    (a_type COLLATE pg_catalog."default" ASC NULLS LAST)
    TABLESPACE pg_default;
-- Index: idx_assessments_user

-- DROP INDEX IF EXISTS core.idx_assessments_user;

CREATE INDEX IF NOT EXISTS idx_assessments_user
    ON core.assessments USING btree
    (user_id ASC NULLS LAST)
    TABLESPACE pg_default;


    -- Table: core.career_recommendations

-- DROP TABLE IF EXISTS core.career_recommendations;

CREATE TABLE IF NOT EXISTS core.career_recommendations
(
    id integer NOT NULL DEFAULT nextval('core.career_recommendations_id_seq'::regclass),
    user_id integer,
    assessment_id integer,
    career_id integer,
    score numeric(5,2),
    rank integer,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT career_recommendations_pkey PRIMARY KEY (id)
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS core.career_recommendations
    OWNER to postgres;
-- Index: idx_career_recommendations_career_id

-- DROP INDEX IF EXISTS core.idx_career_recommendations_career_id;

CREATE INDEX IF NOT EXISTS idx_career_recommendations_career_id
    ON core.career_recommendations USING btree
    (career_id ASC NULLS LAST)
    TABLESPACE pg_default;
-- Index: idx_career_recommendations_created_at

-- DROP INDEX IF EXISTS core.idx_career_recommendations_created_at;

CREATE INDEX IF NOT EXISTS idx_career_recommendations_created_at
    ON core.career_recommendations USING btree
    (created_at DESC NULLS FIRST)
    TABLESPACE pg_default;


    -- Table: core.assessment_sessions

-- DROP TABLE IF EXISTS core.assessment_sessions;

CREATE TABLE IF NOT EXISTS core.assessment_sessions
(
    id bigint NOT NULL DEFAULT nextval('core.assessment_sessions_id_seq'::regclass),
    user_id bigint NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT assessment_sessions_pkey PRIMARY KEY (id),
    CONSTRAINT assessment_sessions_user_id_fkey FOREIGN KEY (user_id)
        REFERENCES core.users (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS core.assessment_sessions
    OWNER to postgres;
-- Index: idx_assessment_sessions_user

-- DROP INDEX IF EXISTS core.idx_assessment_sessions_user;

CREATE INDEX IF NOT EXISTS idx_assessment_sessions_user
    ON core.assessment_sessions USING btree
    (user_id ASC NULLS LAST, created_at ASC NULLS LAST)
    TABLESPACE pg_default;

    