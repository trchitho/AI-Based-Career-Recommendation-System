name: Integration - Contract Tests (FE ↔ BFF)

on:
    pull_request:
        paths:
            - "apps/backend/**"
            - "apps/frontend/**"
            - "packages/ai-core/**"
            - ".github/workflows/integration.yml"
    push:
        branches: ["main"]
        paths:
            - "apps/backend/**"
            - "apps/frontend/**"
            - "packages/ai-core/**"
            - ".github/workflows/integration.yml"

concurrency:
    group: integration-${{ github.ref }}
    cancel-in-progress: true

jobs:
    export-openapi:
        name: Export OpenAPI from FastAPI
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: apps/backend
        env:
            # Dùng SQLite memory để import app mà không cần Postgres thật
            DATABASE_URL: "sqlite+pysqlite:///:memory:"
            AI_MODELS_DIR: "packages/ai-core/models"
            ALLOWED_ORIGINS: "http://localhost:3000"
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install backend deps
              run: |
                  pip install -r requirements.txt
                  # Nếu có package ai-core trong monorepo, cài editable (không bắt buộc)
                  if [ -d ../packages/ai-core ]; then
                    pip install -e ../packages/ai-core
                  fi

            - name: Export openapi.json
              run: |
                  python - <<'PY'
                  import json
                  from app.main import app
                  from fastapi.openapi.utils import get_openapi
                  schema = app.openapi() if hasattr(app, "openapi") else get_openapi(
                      title=app.title, version="0.1.0", routes=app.routes
                  )
                  with open("openapi.json", "w", encoding="utf-8") as f:
                      json.dump(schema, f, ensure_ascii=False, indent=2)
                  print("✅ Exported apps/backend/openapi.json")
                  PY

            - name: Upload OpenAPI artifact
              uses: actions/upload-artifact@v4
              with:
                  name: openapi-spec
                  path: apps/backend/openapi.json

    fe-contract:
        name: FE contract check against OpenAPI
        runs-on: ubuntu-latest
        needs: export-openapi
        defaults:
            run:
                working-directory: apps/frontend
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Download OpenAPI artifact
              uses: actions/download-artifact@v4
              with:
                  name: openapi-spec
                  path: apps/backend

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: "apps/frontend/package-lock.json"

            - name: Install FE deps
              run: npm ci

            - name: Generate TS types from OpenAPI
              # openapi-typescript sẽ tạo file định nghĩa TypeScript từ OpenAPI
              run: npx --yes openapi-typescript ../backend/openapi.json -o src/types/backend.d.ts

            - name: Type check FE
              # Nếu bạn có script riêng, đổi thành: npm run typecheck
              run: npx tsc --noEmit
